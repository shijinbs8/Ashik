{% extends 'base.html' %}
{% block active %}active{% endblock %}
{% block content %}

<div class="container mt-4">
  <h2 class="text-center">Add New Product</h2>

  <form method="post" class="shadow p-4 bg-white rounded">
    {% csrf_token %}

    <!-- Row 1: Name + Medicine Type + Unit -->
    <div class="row mb-3">
      <div class="col-md-4">
        <label class="form-label">Name:</label>
        <input type="text" name="name" class="form-control" required>
      </div>
      <div class="col-md-4">
        <label class="form-label">Medicine Type:</label>
        <select name="medicine_type" class="form-select" required>
          {% for category in categories %}
            <option value="{{ category.id }}">{{ category.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Unit:</label>
        <select name="unit" class="form-select" required>
          {% for unit in units %}
            <option value="{{ unit.id }}">{{ unit.name }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <!-- Row 2: Tax Percentage + MRP -->
    <div class="row mb-3">
      <div class="col-md-6">
        <label class="form-label">Tax Percentage (%):</label>
        <input type="number" id="taxPercentageInput" name="tax_rate" class="form-control" value="{{ tax.percentage }}" readonly required>
        <small class="text-muted" id="taxAmountInfo">Tax Amount: ₹0.00</small>
      </div>
      <div class="col-md-6">
        <label class="form-label">MRP (₹):</label>
        <input type="number" name="mrp" id="mrpInput" class="form-control" step="0.01" required>
      </div>
    </div>

    <!-- Hidden margins -->
    <input type="hidden" id="wholesaleMargin" value="{{ tax.wholesale_margin }}">
    <input type="hidden" id="retailMargin" value="{{ tax.retail_margin }}">

    <!-- Row 3: Cess + Wholesale + Retail + Supplier Rate -->
    <div class="row mb-3">
      <div class="col-md-3">
        <label class="form-label">Cess (%):</label>
        <input type="number" name="cess" class="form-control" step="0.01">
      </div>
      <div class="col-md-3">
        <label class="form-label">Wholesale Price (₹):</label>
        <input type="number" name="wholesale_price" id="wholesalePrice" class="form-control" step="0.01" readonly required>
        <small class="text-muted" id="wholesaleInfo"></small>
      </div>
      <div class="col-md-3">
        <label class="form-label">Retail Price (₹):</label>
        <input type="number" name="retail_price" id="retailPrice" class="form-control" step="0.01" readonly required>
        <small class="text-muted" id="retailInfo"></small>
      </div>
      <div class="col-md-3">
        <label class="form-label">Supplier Rate (₹):</label>
        <input type="number" name="supplier_rate" class="form-control" step="0.01" required>
      </div>
    </div>

    <!-- Row 4: Supplier -->
    <div class="mb-3">
      <label class="form-label">Supplier:</label>
      <select name="supplier" class="form-select" required>
        {% for supplier in suppliers %}
          <option value="{{ supplier.id }}">{{ supplier.name }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Row 5: HSN Code + Manufacturer Code + Bar Code -->
    <div class="row mb-3">
      <div class="col-md-4">
        <label class="form-label">HSN Code:</label>
        <select name="hsn_code" class="form-select" required>
          {% for hsn in hsn_codes %}
            <option value="{{ hsn.id }}">{{ hsn.code }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Manufacturer Code:</label>
        <input type="text" name="manufacturer_code" class="form-control">
      </div>
      <div class="col-md-4">
        <label class="form-label">Bar Code:</label>
        <input type="text" name="bar_code" class="form-control">
      </div>
    </div>

    <!-- Row 6: Location + Stock Quantity -->
    <div class="row mb-3">
      <div class="col-md-6">
        <label class="form-label">Location:</label>
        <input type="text" name="location" class="form-control" required>
      </div>
      <div class="col-md-6">
        <label class="form-label">Stock Quantity:</label>
        <input type="number" name="stock_quantity" class="form-control" required>
      </div>
    </div>

    <button type="submit" class="btn btn-primary w-100 mt-4">Add Product</button>
  </form>
</div>

<!-- Script to auto-calc Tax, Wholesale, Retail -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const mrpInput = document.getElementById("mrpInput");
    const taxPercentageInput = document.getElementById("taxPercentageInput");
    const taxAmountInfo = document.getElementById("taxAmountInfo");
    const wholesalePriceInput = document.getElementById("wholesalePrice");
    const retailPriceInput = document.getElementById("retailPrice");
    const wholesaleInfo = document.getElementById("wholesaleInfo");
    const retailInfo = document.getElementById("retailInfo");

    const taxPercentage = parseFloat(taxPercentageInput.value) || 0;
    const wholesaleMargin = parseFloat(document.getElementById("wholesaleMargin").value) || 0;
    const retailMargin = parseFloat(document.getElementById("retailMargin").value) || 0;

    mrpInput.addEventListener("input", function () {
      const mrp = parseFloat(this.value) || 0;

      // Tax amount based on MRP
      const taxAmount = (mrp * taxPercentage) / 100;
      taxAmountInfo.textContent = `Tax Amount: ₹${taxAmount.toFixed(2)}`;

      // Wholesale and Retail WITHOUT tax
      const wholesaleWithoutTax = (mrp * wholesaleMargin) / 100;
      const retailWithoutTax = (mrp * retailMargin) / 100;

      // Tax-inclusive prices (for info)
      const wholesaleWithTax = wholesaleWithoutTax + (wholesaleWithoutTax * taxPercentage / 100);
      const retailWithTax = retailWithoutTax + (retailWithoutTax * taxPercentage / 100);

      // Fill inputs with prices WITHOUT tax
      wholesalePriceInput.value = wholesaleWithoutTax.toFixed(2);
      retailPriceInput.value = retailWithoutTax.toFixed(2);

      // Show tax-inclusive prices in info labels
      wholesaleInfo.textContent = `(With tax: ₹${wholesaleWithTax.toFixed(2)})`;
      retailInfo.textContent = `(With tax: ₹${retailWithTax.toFixed(2)})`;
    });
  });
</script>

{% endblock %}
