{% extends 'base.html' %}

{% block content %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Invoice</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; }
        .table th, .table td { text-align: center; vertical-align: middle; }
        .invoice-card { max-width: 1200px; margin: auto; }
    </style>

    <div class="container mt-4">
        <div class="card invoice-card">
            <div class="card-body">
                <h4 class="mb-3 text-center">Sales Invoice</h4>
                <div class="invoice-title">
                    <h4 class="float-end font-size-15">Invoice #DS0204 
                        <span class="badge bg-success font-size-12 ms-2">Billing</span>
                    </h4>
                    <div class="mb-4">
                       <h2 class="mb-1 text-muted">{{ user.username }}!</h2>
                    </div>
                    <div class="text-muted">
                        <p class="mb-1">1234 Main Street, Your City</p>
                        <p class="mb-1"><i class="fas fa-envelope me-1"></i> store@email.com</p>
                        <p><i class="fas fa-phone me-1"></i> +123 456 7890</p>
                    </div>
                </div>

                <!-- Form starts here -->
                <form method="POST" action="{% url 'add_sales_invoice' %}">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label"><strong>Billing To:</strong></label>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="billingTo" id="billingCustomer" value="customer" checked>
                            <label class="form-check-label" for="billingCustomer">Customer</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="billingTo" id="billingSupplier" value="supplier">
                            <label class="form-check-label" for="billingSupplier">Supplier</label>
                        </div>
                    </div>
                    <div class="mb-3" id="customerSection">
                        <label for="customerSelect" class="form-label"><strong>Select Customer:</strong></label>
                        <select class="form-select" id="customerSelect" name="customer">
                            <option value="">Select Customer</option>
                            {% for customer in customers %}
                            <option value="{{ customer.id }}" data-address="{{ customer.address }}">{{ customer.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
            
                    <!-- Supplier Selection (Initially Hidden) -->
                    <div class="mb-3" id="supplierSection" style="display: none;">
                        <label for="supplierSelect" class="form-label"><strong>Select Supplier:</strong></label>
                        <select class="form-select" id="supplierSelect" name="supplier">
                            <option value="">Select Supplier</option>
                            {% for supplier in suppliers %}
                            <option value="{{ supplier.id }}" data-address="{{ supplier.address }}">{{ supplier.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
            
                    <!-- Billing Address -->
                    <div class="mb-3">
                        <label for="billingAddress" class="form-label"><strong>Billing Address:</strong></label>
                        <textarea class="form-control" id="billingAddress" name="billing_address" rows="3" placeholder="Enter billing address" readonly></textarea>
                    </div>
            
                    <!-- Billing Type Selection -->
                    <div class="mb-3">
                        <label class="form-label"><strong>Billing Type:</strong></label>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="billingType" id="billingWholesale" value="wholesale" checked>
                            <label class="form-check-label" for="billingWholesale">Wholesale</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="billingType" id="billingRetail" value="retail">
                            <label class="form-check-label" for="billingRetail">Retail</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="billingType" id="billingMRP" value="mrp">
                            <label class="form-check-label" for="billingMRP">MRP</label>
                        </div>
                    </div>
                </div>
                    <!-- Invoice Table -->
                    <table class="table table-bordered" id="invoiceTable">
                        <thead>
                            <tr>
                                <th>No.</th>
                                <th>Medicine Name</th>
                                <th>Type</th>
                                <th>Unit</th>
                                <th>MRP</th>
                                <th>Stock Qty</th>
                                <th>Quantity</th>
                                <th>Total MRP</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="invoiceBody">
                            <tr>
                                <td>1</td>
                                <td>
                                    <select class="form-select productDropdown" name="item_name[]">
                                        <option value="">Select Medicine</option>
                                        {% for product in products %}
                                        <option value="{{ product.id }}">{{ product.name }}</option>
                                        {% endfor %}
                                    </select>
                                </td>
                                <td><input type="text" class="form-control medicine_type" name="medicine_type[]" readonly></td>
                                <td><input type="text" class="form-control unit" name="unit[]" readonly></td>
                                <td><input type="number" class="form-control mrp" name="mrp[]" readonly></td>
                                <td><input type="number" class="form-control stock_quantity" readonly></td>
                                <td><input type="number" class="form-control quantity" name="qty[]" min="1" value="1"></td>
                                <td><input type="number" class="form-control total_mrp" name="subtotal[]" readonly></td>
                                <td>
                                    <button type="button" class="btn btn-danger removeRow">X</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>

                    <button type="button" class="btn btn-primary" id="addRow">+ Add Medicine</button>

                    <!-- Grand Total -->
                    <div class="text-end mt-3">
                        <h5><strong>Grand Total: â‚¹<span id="grandTotal">0.00</span></strong></h5>
                    </div>

                    <!-- Submit Button -->
                    <div class="text-center mt-4">
                        <button type="submit" class="btn btn-success">Submit Invoice</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <script>
        document.getElementById("addRow").addEventListener("click", function() {
    let table = document.getElementById("medicineTable").getElementsByTagName("tbody")[0];
    let rowCount = table.rows.length;
    
    let newRow = table.insertRow();
    newRow.innerHTML = `
        <td><input type="text" name="medicine_name[]" class="form-control" id="medicine_name_${rowCount}"></td>
        <td><input type="number" name="quantity[]" class="form-control" id="quantity_${rowCount}"></td>
        <td><input type="number" name="price[]" class="form-control" id="price_${rowCount}" step="0.01"></td>
        <td><input type="number" name="total[]" class="form-control" id="total_${rowCount}" readonly></td>
        <td><button type="button" class="btn btn-danger removeRow">X</button></td>
    `;

    // Event listener for removing row
    newRow.querySelector(".removeRow").addEventListener("click", function() {
        newRow.remove();
    });
});

    </script>
    <script>
        $(document).ready(function () {
            // Toggle Customer/Supplier selection
            $("input[name='billingTo']").change(function () {
                if ($(this).val() === "customer") {
                    $("#customerSection").show();
                    $("#supplierSection").hide();
                    $("#supplierSelect").val(""); // Reset supplier selection
                } else {
                    $("#customerSection").hide();
                    $("#supplierSection").show();
                    $("#customerSelect").val(""); // Reset customer selection
                }
                $("#billingAddress").val(""); // Reset billing address
            });

            // Handle Customer Selection
            $("#customerSelect").change(function () {
                var selectedOption = $(this).find("option:selected");
                var customerAddress = selectedOption.data("address") || "";
                $("#billingAddress").val(customerAddress);
            });

            // Handle Supplier Selection
            $("#supplierSelect").change(function () {
                var selectedOption = $(this).find("option:selected");
                var supplierAddress = selectedOption.data("address") || "";
                $("#billingAddress").val(supplierAddress);
            });
    
            // Function to update total MRP for a row
            function updateTotal(row) {
                var mrp = parseFloat(row.find(".mrp").val()) || 0;
                var quantity = parseInt(row.find(".quantity").val()) || 1;
                var totalMrp = mrp * quantity;
                row.find(".total_mrp").val(totalMrp.toFixed(2));
                calculateGrandTotal();
            }
    
            // Function to calculate grand total
            function calculateGrandTotal() {
                var grandTotal = 0;
                $(".total_mrp").each(function () {
                    grandTotal += parseFloat($(this).val()) || 0;
                });
                $("#grandTotal").text(grandTotal.toFixed(2));
            }
    
            // Fetch product list dynamically
            function fetchProductList() {
                $.ajax({
                    url: "/Product/get-product-list/",
                    type: "GET",
                    dataType: "json",
                    success: function (data) {
                        $(".productDropdown").each(function () {
                            var dropdown = $(this);
                            dropdown.empty().append('<option value="">Select Product</option>');
                            $.each(data.products, function (index, product) {
                                dropdown.append(`<option value="${product.id}">${product.name}</option>`);
                            });
                        });
                    },
                    error: function (xhr, status, error) {
                        console.error("Error fetching product list:", error);
                    }
                });
            }
    
            fetchProductList();
    
            // Update product details when a product is selected
            $(document).on("change", ".productDropdown", function () {
                var row = $(this).closest("tr");
                var productId = $(this).val();
                if (productId) {
                    $.ajax({
                        url: "/Product/get-product-details/" + productId + "/",
                        type: "GET",
                        dataType: "json",
                        success: function (data) {
                            row.find(".medicine_type").val(data.medicine_type);
                            row.find(".unit").val(data.unit);
                            row.find(".mrp").val(data.mrp);
                            row.find(".stock_quantity").val(data.stock_quantity);
                            updateTotal(row);
                        },
                        error: function (xhr, status, error) {
                            console.error("Error fetching product details:", error);
                        }
                    });
                } else {
                    row.find("input").val("");
                    updateTotal(row);
                }
            });
    
            // Update total when quantity changes
            $(document).on("input", ".quantity", function () {
                var row = $(this).closest("tr");
                updateTotal(row);
            });
    
            // Add a new row
            $("#addRow").click(function () {
                var newRow = $("#invoiceBody tr:first").clone();
                newRow.find("input, select").val("");
                newRow.find(".quantity").val(1);
                $("#invoiceBody").append(newRow);
                fetchProductList();
            });
    
            // Remove a row
            $(document).on("click", ".removeRow", function () {
                $(this).closest("tr").remove();
                calculateGrandTotal();
            });
        });
    </script>
    
    <script>
        $(document).ready(function() {
            $('input[name="billingType"]').change(function() {
                let selectedType = $('input[name="billingType"]:checked').val();
                console.log("Selected Billing Type:", selectedType);
    
                $(".productDropdown").each(function() {
                    let productId = $(this).val();
                    let priceField = $(this).closest("tr").find(".mrp");
    
                    if (productId) {
                        $.ajax({
                            url: `/Product/get-product-price/${productId}/`,  // Endpoint to fetch price based on billing type
                            type: "GET",
                            data: { billingType: selectedType },
                            success: function(response) {
                                priceField.val(response.price);
                            }
                        });
                    }
                });
            });
        });
    </script>

    
{% endblock %}